name: Deploy

on:
  push:
    branches: [master]

jobs:
  build_and_prepare:
    name: Build frontend (prod) & prepare backend
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22 with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci || npm install

      - name: Build frontend (Vite, production)
        working-directory: client
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PROD_API_URL }}
        run: npm run build

      - name: Install backend dependencies
        working-directory: server
        run: npm ci || npm install

      - name: Prepare backend env (production)
        env:
          JWT_SECRET_PROD: ${{ secrets.JWT_SECRET_PROD }}
          PROD_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: |
          mkdir -p server
          {
            echo "NODE_ENV=production";
            echo "JWT_SECRET=${JWT_SECRET_PROD}";
            if [ -n "${PROD_MONGODB_URI}" ]; then echo "MONGODB_URI=${PROD_MONGODB_URI}"; fi
          } > server/.env.production

      - name: Exécuter les migrations MongoDB (versionnées & traçables)
        working-directory: server
        env:
          NODE_ENV: production
          MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: |
          set -euo pipefail
          if [ -z "${MONGODB_URI:-}" ]; then
            echo "Secret PROD_MONGODB_URI manquant."
            exit 1
          fi
          # Suppose un fichier de config présent: server/migrate-mongo-config.js
          # et des migrations versionnées dans server/migrations.
          npx --yes migrate-mongo@^11 up

  notify:
    name: Notify Build/Prepare Result
    runs-on: ubuntu-latest
    needs: [build_and_prepare]
    if: always()
    environment:
      name: production
    steps:
      - name: Summary and annotation
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RESULT: ${{ needs.build_and_prepare.result }}
        with:
          script: |
            const result = process.env.RESULT;
            const ok = result === 'success';
            const title = ok ? '✅ Build & Prepare réussi' : '❌ Build & Prepare échoué';
            const msg = `${title} - Branche: ${process.env.BRANCH}, Commit: ${process.env.SHA}`;
            if (!ok) core.error(msg); else core.notice(msg);
            let out = `# ${title}\n\n- Branche: ${process.env.BRANCH}\n- Commit: ${process.env.SHA}\n- Statut: ${result}\n`;
            await core.summary.addRaw(out).write();
