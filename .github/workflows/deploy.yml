name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version ou commit √† d√©ployer'
        required: false
        default: 'latest'

jobs:
  build_and_prepare:
    name: Build frontend (prod) & prepare backend
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.sha }}

      - name: Setup Node.js 22 with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci || npm install

      - name: Build frontend (Vite, production)
        working-directory: client
        env:
          NODE_ENV: production
        run: npm run build

      - name: Install backend dependencies
        working-directory: server
        run: npm ci || npm install

      - name: Prepare backend env (production)
        env:
          JWT_SECRET_PROD: ${{ secrets.JWT_SECRET_PROD }}
          PROD_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: |
          mkdir -p server
          {
            echo "NODE_ENV=production";
            echo "JWT_SECRET=${JWT_SECRET_PROD}";
            if [ -n "${PROD_MONGODB_URI}" ]; then echo "MONGODB_URI=${PROD_MONGODB_URI}"; fi
          } > server/.env.production

      - name: Run database migrations
        working-directory: server
        env:
          NODE_ENV: production
          MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: |
          echo "Running MongoDB migrations..."
          npm run migrate  # ex: script: "migrate": "node ./migrations/run.js"
          echo "Migrations completed."

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [ build_and_prepare ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service backend

  post_deploy_tests:
    name: Post-deploy Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    environment:
      name: production
    steps:
      - name: Health check main API
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PROD_API_URL }}/health")
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå Health check failed with status $STATUS"
            exit 1
          fi
          echo "‚úÖ API health check passed."

      - name: Check critical endpoints
        run: |
          ENDPOINTS=(
            "/api/v1/users"
            "/api/v1/orders"
          )
          for path in "${ENDPOINTS[@]}"; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PROD_API_URL }}$path")
            if [ "$CODE" -ne 200 ]; then
              echo "‚ùå Endpoint $path failed (HTTP $CODE)"
              exit 1
            fi
          done
          echo "‚úÖ All endpoints healthy."

  rollback:
    name: Rollback on failure
    runs-on: ubuntu-latest
    needs: [post_deploy_tests]
    if: ${{ needs.post_deploy_tests.result != 'success' }}
    environment:
      name: production
    steps:
      - name: Rollback to previous version
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "${SSH_PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem ubuntu@${SERVER_IP} << 'EOF'
            cd /var/www/app
            echo "Rolling back to previous version..."
            git reset --hard HEAD~1
            npm ci --omit=dev
            npm run build
            pm2 restart app
          EOF

  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [post_deploy_tests, rollback]
    if: always()
    environment:
      name: production
    steps:
      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: |
            üöÄ D√©ploiement ${{ needs.post_deploy_tests.result == 'success' && 'r√©ussi' || '√©chou√©' }}
          to: "devops@votredomaine.com"
          from: "GitHub Actions <no-reply@votredomaine.com>"
          body: |
            Environnement: production
            R√©sultat: ${{ needs.post_deploy_tests.result }}
            Branche: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            $(if [ "${{ needs.post_deploy_tests.result }}" == "failure" ]; then echo "Rollback effectu√©."; fi)
