name: Deploy

on:
  push:
    branches: [master]

jobs:
  build_and_prepare:
    name: Build frontend (prod) & prepare backend
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22 with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci || npm install

      - name: Build frontend (Vite, production)
        working-directory: client
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PROD_API_URL }}
        run: npm run build

      - name: Install backend dependencies
        working-directory: server
        run: npm ci || npm install

      - name: Prepare backend env (production)
        env:
          JWT_SECRET_PROD: ${{ secrets.JWT_SECRET_PROD }}
          PROD_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: |
          mkdir -p server
          {
            echo "NODE_ENV=production";
            echo "JWT_SECRET=${JWT_SECRET_PROD}";
            if [ -n "${PROD_MONGODB_URI}" ]; then echo "MONGODB_URI=${PROD_MONGODB_URI}"; fi
          } > server/.env.production

  post_deploy_health_check:
    name: Post-deploy health checks
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Vérifier endpoints critiques
        env:
          BASE_URL: ${{ secrets.PROD_API_URL }}
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "Secret PROD_API_URL manquant."
            exit 1
          fi

          endpoints=(
            "/health"
          )

          fail=0
          for path in "${endpoints[@]}"; do
            url="${BASE_URL%/}${path}"
            echo "Health check: ${url}"
            ok=0
            for i in {1..10}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" "${url}" || true)
              if [ "${status}" = "200" ]; then
                echo "OK ${url} -> 200"
                ok=1
                break
              fi
              echo "Tentative ${i}/10 échouée (statut=${status}). Retry dans 3s..."
              sleep 3
            done
            if [ "${ok}" -ne 1 ]; then
              echo "Endpoint non sain: ${url} (dernier statut=${status})"
              fail=1
            fi
          done

          if [ "${fail}" -ne 0 ]; then
            exit 1
          fi

      - name: Résumé health checks
        if: always()
        uses: actions/github-script@v7
        env:
          API: ${{ secrets.PROD_API_URL }}
        with:
          script: |
            const api = process.env.API || 'n/a';
            const status = core.getInput('status') || 'see job log';
            await core.summary
              .addRaw(`# Health checks\n\n`)
              .addRaw(`- API: ${api}\n`)
              .addRaw(`- Résultat: ${github.job}\n`)
              .write();

  notify:
    name: Notify Build/Prepare Result
    runs-on: ubuntu-latest
    needs: [build_and_prepare]
    if: always()
    environment:
      name: production
    steps:
      - name: Summary and annotation
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RESULT: ${{ needs.build_and_prepare.result }}
        with:
          script: |
            const result = process.env.RESULT;
            const ok = result === 'success';
            const title = ok ? '✅ Build & Prepare réussi' : '❌ Build & Prepare échoué';
            const msg = `${title} - Branche: ${process.env.BRANCH}, Commit: ${process.env.SHA}`;
            if (!ok) core.error(msg); else core.notice(msg);
            let out = `# ${title}\n\n- Branche: ${process.env.BRANCH}\n- Commit: ${process.env.SHA}\n- Statut: ${result}\n`;
            await core.summary.addRaw(out).write();
